# Chapter 2.5: 多聚合器架構與輪替演算法

**總頁數預算**: 1.5頁
**寫作風格**: 教科書式客觀描述，現在式，說明性（非批判性）

---

## 2.5.1 輪替選擇演算法

在多聚合器聯邦學習架構中，如何公平且高效地分配聚合任務是系統設計的關鍵問題。輪替選擇(Round-Robin Selection)機制提供了一種簡單而有效的解決方案，通過循環輪流的方式確保每個聚合器公平地承擔聚合責任。

### Round-Robin原理

Round-Robin是一種循環調度策略，廣泛應用於作業系統進程調度、網絡負載均衡等場景。其核心思想是按照固定順序依次分配資源或任務，當到達序列末端時，重新從頭開始循環。

在多聚合器聯邦學習場景中，Round-Robin機制的運作方式如下：

1. **聚合器註冊**：系統維護一個包含N個聚合器的有序列表 $\mathcal{A} = \{A_0, A_1, ..., A_{N-1}\}$
2. **順序分配**：第r輪訓練由聚合器 $A_{(r-1) \bmod N}$ 負責
3. **循環重複**：當所有聚合器都執行過一次聚合後，重新從 $A_0$ 開始

這種設計具有以下特性：

- **確定性**：給定輪次r，能唯一確定負責的聚合器
- **公平性**：在R輪訓練中，每個聚合器負責的輪次數量相近，差異不超過1
- **簡單性**：選擇邏輯的計算複雜度為O(1)

### 聚合器選擇演算法

考慮到實際系統中可能存在被排除的惡意聚合器，完整的聚合器選擇演算法需要處理排除清單(Exclusion List)。

**算法2.5.1：多聚合器輪替選擇**

```
輸入：當前回合 r，聚合器總數 N，排除清單 E
輸出：選定的聚合器ID a

1: a ← (r - 1) mod N                    // 計算基礎索引
2: while a ∈ E do                        // 檢查是否被排除
3:     r ← r + 1                         // 移動到下一個候選
4:     a ← (r - 1) mod N
5: end while
6: return a
```

**演算法說明**：

- **第1行**：使用模運算計算基礎聚合器索引。使用 $(r-1)$ 而非 $r$ 是為了使索引從0開始（假設輪次從1開始計數）
- **第2-5行**：若選中的聚合器在排除清單中，則跳過並選擇下一個聚合器，循環此過程直到找到有效聚合器
- **第6行**：返回最終選定的聚合器ID

**數學表達**：

正式地，聚合器選擇函數可表示為：

$$\text{Select}(r, N, E) = \min \{a \in \mathbb{Z}_N \mid a \equiv (r + k - 1) \pmod{N}, k \geq 0, a \notin E\}$$

其中 $\mathbb{Z}_N = \{0, 1, ..., N-1\}$ 為聚合器索引集合。

### 複雜度分析

**時間複雜度**：

1. **最佳情況**（無排除）：O(1)
   - 僅需執行一次模運算和一次集合查詢

2. **平均情況**（排除率為p）：
   設排除清單大小為 $|E| = pN$，則平均需要檢查的聚合器數量為：

   $$\mathbb{E}[\text{檢查次數}] = \sum_{k=1}^{\infty} k \cdot (1-p) \cdot p^{k-1} = \frac{1}{1-p}$$

   當 $p < 0.5$ 時（大多數聚合器誠實），平均複雜度仍為O(1)常數級

3. **最壞情況**（$|E| = N-1$）：O(N)
   - 需要遍歷所有聚合器才能找到唯一的有效選擇

**空間複雜度**：

- 排除清單E的存儲：O(|E|)
- 演算法本身：O(1)（僅使用常數個臨時變量）

### 公平性保證

**定理2.5.1**（公平性）：在無排除的情況下，經過R輪訓練後，每個聚合器被選中的次數為 $\lfloor R/N \rfloor$ 或 $\lceil R/N \rceil$，差異不超過1。

**證明**：

設聚合器 $A_i$ 在R輪訓練中被選中的次數為 $C_i$。根據Round-Robin規則：

$$C_i = |\{r \in \{1, 2, ..., R\} \mid (r-1) \bmod N = i\}|$$

將R表示為 $R = qN + s$，其中 $q = \lfloor R/N \rfloor$，$s = R \bmod N$（餘數，$0 \leq s < N$）。

- 對於 $i < s$：聚合器 $A_i$ 被選中 $q+1$ 次（在每個完整循環q次，加上最後不完整循環中的1次）
- 對於 $i \geq s$：聚合器 $A_i$ 被選中 $q$ 次（僅在完整循環中）

因此：
$$C_i = \begin{cases}
\lceil R/N \rceil = q+1 & \text{if } i < s \\
\lfloor R/N \rfloor = q & \text{if } i \geq s
\end{cases}$$

最大差異為 $(q+1) - q = 1$。證畢。

### 與其他選擇機制的比較

**表2.5.1：聚合器選擇機制對比**

| 機制 | 公平性 | 可預測性 | 計算複雜度 | 抗攻擊能力 | 適用場景 |
|------|--------|----------|-----------|-----------|----------|
| Round-Robin | 極高 | 高（完全確定） | O(1) | 中等 | 可信環境、公平分配 |
| 隨機選擇 | 高 | 低（隨機） | O(1) | 低（Sybil脆弱） | 探索性場景 |
| 聲譽導向 | 中 | 中 | O(N) | 高 | 激勵誠實行為 |
| 質押權重 | 低 | 中 | O(N log N) | 高 | 經濟博弈場景 |

**Round-Robin的優勢**：

1. **計算效率**：O(1)選擇時間，無需維護複雜的評分或權重系統
2. **公平保證**：數學可證的公平性，避免資源分配不均
3. **實現簡單**：邏輯清晰，易於實現和驗證

**潛在考量**：

- **可預測性**：攻擊者可預測自己的聚合輪次，可能針對性地發動攻擊。此問題需通過挑戰機制和經濟激勵來緩解（詳見2.4節和2.6節）
- **無質量區分**：Round-Robin不考慮聚合器的歷史表現或計算能力差異。在需要根據性能動態調整分配的場景中，可能需要結合其他機制

---

## 2.5.2 負載分散的數學模型

多聚合器架構的核心優勢在於通過分散計算負載，顯著降低單個節點的計算壓力。本節建立數學模型，量化分析負載分散的效率提升。

### 單聚合器模型

在傳統的單聚合器聯邦學習架構中，一個中央聚合器負責所有訓練輪次的聚合工作。

**計算負擔分析**：

設聯邦學習任務包含：
- R：總訓練輪次
- K：參與客戶端數量
- d：模型參數維度
- $T_{\text{agg}}(K, d)$：執行一次聚合的計算時間

單個聚合器的總計算負擔為：

$$W_{\text{single}} = R \cdot T_{\text{agg}}(K, d)$$

對於標準的聯邦平均(FedAvg)算法，聚合計算涉及K個模型的加權平均：

$$w^{(t+1)} = \sum_{k=1}^{K} \frac{n_k}{n} w_k^{(t)}$$

其中 $n_k$ 為客戶端k的數據量，$n = \sum_{k=1}^{K} n_k$。

**時間複雜度**：

每次聚合需要：
1. 載入K個模型：O(K·d)時間
2. 計算加權和：O(K·d)算術運算
3. 寫回結果：O(d)時間

總計算複雜度：$T_{\text{agg}}(K, d) = O(K \cdot d)$

因此，單聚合器的總計算複雜度為：

$$W_{\text{single}} = O(R \cdot K \cdot d)$$

**瓶頸分析**：

- 當R或K增加時，單聚合器的負擔線性增長
- 在大規模聯邦學習場景中（K > 1000，R > 100），單點計算成為系統瓶頸
- 聚合器的硬體資源需求高，限制了系統的可擴展性

### 多聚合器模型

多聚合器架構通過輪替機制將聚合任務分散至N個聚合器。

**計算負擔分配**：

假設聚合器集合為 $\mathcal{A} = \{A_1, A_2, ..., A_N\}$，且各聚合器計算能力相同。在無排除的理想情況下，根據定理2.5.1，每個聚合器負責的輪次數量為：

$$R_i = \begin{cases}
\lceil R/N \rceil & \text{for } i \leq (R \bmod N) \\
\lfloor R/N \rfloor & \text{otherwise}
\end{cases}$$

平均每個聚合器的計算負擔為：

$$W_{\text{multi}} = \frac{R}{N} \cdot T_{\text{agg}}(K, d) = \frac{R}{N} \cdot O(K \cdot d)$$

**效率提升量化**：

定義效率提升倍數(Efficiency Gain)為單聚合器負擔與多聚合器負擔的比值：

$$\text{Gain}_{\text{comp}} = \frac{W_{\text{single}}}{W_{\text{multi}}} = \frac{R \cdot T_{\text{agg}}(K, d)}{\frac{R}{N} \cdot T_{\text{agg}}(K, d)} = N$$

**結論**：在計算負擔維度上，多聚合器架構實現了**N倍**的線性效率提升。

### 數值範例

**場景設定**：

- R = 100 輪訓練
- K = 1000 個客戶端
- d = 10^7 參數（約40MB模型，如ResNet-50）
- N = 10 個聚合器
- 單次聚合時間：$T_{\text{agg}} \approx 30$ 秒（包含網絡傳輸和計算）

**單聚合器場景**：

$$W_{\text{single}} = 100 \times 30 = 3000 \text{ 秒} \approx 50 \text{ 分鐘}$$

**多聚合器場景（N=10）**：

$$W_{\text{multi}} = \frac{100}{10} \times 30 = 300 \text{ 秒} \approx 5 \text{ 分鐘}$$

**效率提升**：

$$\text{Gain}_{\text{comp}} = \frac{3000}{300} = 10 \text{ 倍}$$

每個聚合器僅需承擔原本1/10的計算負擔。

### 可擴展性分析

**定理2.5.2**（線性可擴展性）：在多聚合器架構中，系統總計算容量隨聚合器數量線性增長。

**證明**：

系統總計算容量定義為單位時間內可完成的聚合次數。設單個聚合器的計算速率為 $\mu = 1 / T_{\text{agg}}$（次/秒）。

對於N個聚合器的系統，若各聚合器獨立並行工作，系統總計算速率為：

$$\mu_{\text{system}} = N \cdot \mu = \frac{N}{T_{\text{agg}}}$$

當訓練任務增加至R'輪時，所需總時間為：

$$T_{\text{total}} = \frac{R'}{N \cdot \mu} = \frac{R' \cdot T_{\text{agg}}}{N}$$

可見總時間與N成反比，即計算容量與N成正比。證畢。

**實際意義**：

- **彈性擴展**：當聯邦學習任務規模擴大時，可通過增加聚合器數量線性提升系統容量
- **成本優化**：可使用較低配置的多台服務器替代高配置的單台服務器，降低硬體成本
- **容錯提升**：單個聚合器故障僅影響1/N的系統容量，而非完全中斷

### 負載均衡分析

在實際系統中，可能存在聚合器計算能力異質(heterogeneous)的情況。設聚合器 $A_i$ 的計算速率為 $\mu_i$（可能不同），則系統總計算速率為：

$$\mu_{\text{system}} = \sum_{i=1}^{N} \mu_i$$

若希望最小化最大負載（load balancing優化目標），需將聚合任務分配與聚合器計算能力成比例：

$$R_i = R \cdot \frac{\mu_i}{\sum_{j=1}^{N} \mu_j}$$

在同質(homogeneous)情況下（$\mu_i = \mu$），此公式退化為均勻分配 $R_i = R/N$，與Round-Robin結果一致。

### 通訊開銷考量

除計算負擔外，通訊開銷也是系統效率的重要因素。

**單聚合器通訊**：

- 上行：K個客戶端各傳輸模型至聚合器，總量 $K \cdot d$ 參數/輪
- 下行：聚合器廣播全局模型至K個客戶端，總量 $K \cdot d$ 參數/輪
- 總通訊量：$2K \cdot d$ 參數/輪

**多聚合器通訊**：

- 每輪仍需K個客戶端上傳和接收模型
- 輪替僅改變聚合者身份，不增加額外通訊
- 總通訊量：$2K \cdot d$ 參數/輪（與單聚合器相同）

**重要觀察**：多聚合器架構在降低計算負擔的同時，**不增加系統總通訊量**。這是因為輪替機制僅分散了計算任務，而非引入額外的協調通訊。

### 總結

多聚合器架構通過輪替機制實現了計算負載的線性分散，帶來以下量化優勢：

1. **計算負擔降低**：每個聚合器的負擔從 $O(R \cdot K \cdot d)$ 降至 $O(\frac{R}{N} \cdot K \cdot d)$，提升N倍
2. **線性可擴展性**：系統總計算容量與聚合器數量N成正比
3. **通訊效率**：總通訊量保持不變，無額外協調開銷
4. **公平分配**：通過Round-Robin確保每個聚合器負擔差異不超過一個聚合任務

這些特性使得多聚合器架構特別適合需要處理大量客戶端和長時間訓練的聯邦學習場景。

---

## 小結

本節介紹了多聚合器架構的核心機制——輪替選擇演算法及其負載分散效益。Round-Robin輪替機制通過簡單的模運算實現O(1)複雜度的聚合器選擇，並保證數學可證的公平性。通過引入排除清單，系統能夠動態剔除惡意聚合器，同時保持選擇效率。負載分散的數學模型顯示，多聚合器架構將單個節點的計算負擔降低N倍，實現線性可擴展性，且不增加系統總通訊量。這種設計為聯邦學習系統提供了高效、公平且可擴展的聚合任務分配方案。

---

**字數統計**：約3,800字（繁體中文）
**深度標準檢查**：
- ✅ 包含完整偽代碼（算法2.5.1）
- ✅ 包含數學推導和證明（定理2.5.1、2.5.2）
- ✅ 複雜度分析（時間、空間）
- ✅ 量化效率提升（N倍）
- ✅ 未討論動態排除細節（留給Ch4）
- ✅ 未涉及PBFT模式複雜度（留給Ch3）
- ✅ 客觀描述，非批判性
