# 2.3 拜占庭容錯機制

分散式系統在面對節點故障時，必須具備持續運作的能力。然而，當故障不僅止於節點停機，而是節點可能展現任意惡意行為——包括發送矛盾訊息、選擇性沉默或與其他惡意節點協同攻擊——系統便需要更強韌的容錯機制。在區塊鏈驅動的聯邦學習系統中，負責模型聚合的節點若遭攻陷，可能產生錯誤的聚合結果並試圖將其寫入區塊鏈，此類威脅本質上即屬於拜占庭故障。因此，理解拜占庭容錯的基本原理與安全性閾值，是設計可信賴 BCFL 架構的必要前提。

本節首先介紹拜占庭將軍問題的理論基礎，建立容錯閾值的數學基礎；接著說明實用拜占庭容錯協議（PBFT）的運作原理，作為後續挑戰機制設計的安全性後盾；最後探討委員會架構如何在 BCFL 領域應用，並指出現有方法在面對長期攻擊時的根本性侷限。

## 2.3.1 拜占庭將軍問題與容錯閾值

### 問題的起源與形式化定義

拜占庭將軍問題由 Lamport、Shostak 與 Pease 於 1982 年正式提出 [1]。問題的設定源自一個軍事隱喻：拜占庭帝國的數支軍隊包圍敵城，各軍由一位將軍指揮，將軍們僅能透過信使相互通訊。然而，部分將軍可能是叛徒，他們會刻意傳遞錯誤訊息以阻撓忠誠將軍達成一致決策。問題的核心在於：如何設計一個演算法，使得所有忠誠將軍能就「進攻」或「撤退」達成共識，即使存在叛徒試圖破壞協調？

此問題的形式化定義包含兩個交互一致性條件（Interactive Consistency Conditions）：

- **IC1（一致性）**：所有忠誠副官必須執行相同的命令。
- **IC2（正確性）**：若指揮官是忠誠的，則所有忠誠副官必須執行指揮官發出的命令。

這兩個條件共同確保了分散式系統的基本安全性：忠誠節點不會因惡意節點的干擾而產生分歧，且正確的輸入能夠被正確地傳播。將此問題對應到區塊鏈聯邦學習的場景：將軍對應驗證節點，信使對應網路通訊，叛徒對應被攻陷或惡意的聚合器與驗證者。

### 三分之一閾值的不可能性證明

拜占庭將軍問題存在一個根本性的數學限制：在僅使用口頭訊息（Oral Messages）的情況下，問題可解若且唯若超過三分之二的參與者是忠誠的。換言之，若系統中有 $n$ 個節點，最多只能容忍 $f$ 個拜占庭節點，其中 $n \geq 3f + 1$。

此限制可透過最簡單的三節點、一叛徒場景直觀理解。考慮以下兩種情境：

**情境一**：指揮官是忠誠的，發送「進攻」命令給兩位副官 A 與 B。副官 B 是叛徒，他向副官 A 謊稱「指揮官說撤退」。此時副官 A 收到兩個矛盾訊息：來自指揮官的「進攻」與來自 B 轉述的「撤退」。

**情境二**：指揮官是叛徒，他向副官 A 發送「進攻」，向副官 B 發送「撤退」。兩位忠誠副官如實向對方轉述各自收到的命令。副官 A 同樣收到兩個矛盾訊息：來自指揮官的「進攻」與來自 B 轉述的「撤退」。

關鍵的洞察在於：從副官 A 的視角來看，情境一與情境二完全無法區分。若叛徒能夠一致地說謊，副官 A 便無法判斷叛徒究竟是指揮官還是另一位副官。任何確定性演算法在此情境下都必然失敗，這從根本上限制了拜占庭容錯系統的設計空間。

此 $n \geq 3f + 1$ 的閾值源於一個簡單的算術事實：當需要確認某個值是否正確時，系統必須能夠獲得足夠多的一致回應以排除惡意節點的干擾。若 $f$ 個節點可能說謊，則需要至少 $2f + 1$ 個節點的確認才能確保至少 $f + 1$ 個回應來自誠實節點。由於總節點數必須包含這 $2f + 1$ 個確認節點加上 $f$ 個可能的惡意節點，故 $n \geq 3f + 1$。

### 故障模型的層級區分

在分散式系統的容錯理論中，故障模型依嚴重程度可分為多個層級。表 2-X 比較了兩種最常見的故障模型——崩潰故障與拜占庭故障——的特性差異。

| 特性 | 崩潰故障 | 拜占庭故障 |
|------|---------|-----------|
| 行為特徵 | 節點停止運作後不再發送訊息 | 節點可能展現任意行為，包括發送矛盾訊息 |
| 可偵測性 | 可透過心跳逾時機制偵測 | 無法透過簡單機制直接偵測 |
| 容錯閾值 | $f < n/2$（少數服從多數） | $f < n/3$（需要超額多數） |
| 典型協議 | Paxos [2]、Raft [3] | PBFT [4]、HotStuff [5]、Tendermint [6] |
| 應用場景 | 可信環境中的分散式資料庫 | 開放或半開放環境的區塊鏈系統 |

崩潰故障假設節點一旦故障便完全停止運作，這在資料中心等可控環境中是合理的假設。然而，在區塊鏈聯邦學習的場景中，節點可能被攻擊者控制而展現惡意行為，單純的崩潰容錯機制無法提供足夠的安全保證。拜占庭容錯需要更嚴格的 $n \geq 3f + 1$ 閾值，正是因為惡意節點可能向不同節點發送不同訊息，使得僅憑簡單多數決無法辨別真偽。

## 2.3.2 實用拜占庭容錯協議

### PBFT 的設計動機與定位

拜占庭將軍問題的理論解法雖然在 1982 年即已提出，但早期解法的指數級通訊複雜度使其僅具理論意義。1999 年，Castro 與 Liskov 提出實用拜占庭容錯協議（Practical Byzantine Fault Tolerance, PBFT）[4]，首次將 BFT 共識的通訊複雜度降至多項式級別 $O(n^2)$，使其在實際系統中可行。PBFT 的設計目標是在部分同步網路模型下，以合理的效能代價換取對任意惡意行為的容錯能力。

在本研究的架構中，PBFT 扮演的角色是挑戰機制觸發時的安全性後盾。當系統偵測到可疑的聚合行為並發起挑戰時，需要一個能夠抵禦拜占庭攻擊的共識機制來仲裁爭議。PBFT 的成熟理論基礎與經過驗證的安全性保證，使其成為此角色的理想選擇。

### 三階段協議流程

PBFT 協議需要 $n = 3f + 1$ 個副本節點（Replica），其中一個被指定為主節點（Primary），負責為客戶端請求分配序號並發起共識。協議透過三個階段達成共識：

**階段一：Pre-prepare（預準備）**

主節點 $p$ 收到客戶端請求 $m$ 後，為其分配一個序號 $n$，並向所有副本廣播預準備訊息：

$$\langle\text{PRE-PREPARE}, v, n, D(m)\rangle_{\sigma_p}$$

其中 $v$ 為當前視圖編號，$D(m)$ 為請求的摘要，$\sigma_p$ 為主節點的數位簽章。此階段的通訊複雜度為 $O(n)$，因為主節點僅需向所有副本發送一次訊息。

**階段二：Prepare（準備）**

副本節點收到預準備訊息後，驗證其有效性：視圖編號是否正確、序號是否在有效範圍內、是否已接受過相同序號但不同摘要的訊息。驗證通過後，副本向所有其他節點廣播準備訊息：

$$\langle\text{PREPARE}, v, n, d, i\rangle_{\sigma_i}$$

當某節點收集到 $2f$ 個來自不同節點的匹配準備訊息（加上自身持有的預準備訊息，共 $2f + 1$ 票），即進入 prepared 狀態。此階段每個節點都向其他所有節點發送訊息，通訊複雜度為 $O(n^2)$。

**階段三：Commit（提交）**

進入 prepared 狀態的副本向所有節點廣播提交訊息：

$$\langle\text{COMMIT}, v, n, d, i\rangle_{\sigma_i}$$

當節點收集到 $2f + 1$ 個匹配的提交訊息，即進入 committed-local 狀態，可執行請求並回覆客戶端。此階段的通訊複雜度同樣為 $O(n^2)$。

### 通訊複雜度分析

PBFT 的總通訊複雜度由三個階段累加：

$$\text{總複雜度} = O(n) + O(n^2) + O(n^2) = O(n^2)$$

以 $n = 4$、$f = 1$ 的最小配置為例：預準備階段產生 3 則訊息，準備階段產生 $4 \times 3 = 12$ 則訊息，提交階段同樣產生 12 則訊息，每輪共識總計 27 則訊息。當節點數增加至 $n = 21$（可容忍 7 個拜占庭節點）時，每輪訊息數增至約 870 則。

此二次方複雜度是 PBFT 的主要效能瓶頸，限制了其在大規模網路中的應用。實務上，傳統 PBFT 部署通常限制在 10 至 20 個節點。然而，在本研究的目標場景——許可制聯盟鏈環境下的聯邦學習——驗證者數量通常在此範圍內，PBFT 的通訊成本是可接受的。更重要的是，本研究採用的樂觀執行機制使得 PBFT 僅在挑戰發生時才被觸發，大幅降低了實際的平均通訊開銷。

### 視圖更換與活性保證

PBFT 的安全性（Safety）保證所有誠實節點對請求序列達成一致，其核心依據是 Quorum 交叉原理。任意兩個大小為 $2f + 1$ 的節點群體，其交集至少包含：

$$\text{交集大小} = (2f + 1) + (2f + 1) - (3f + 1) = f + 1$$

由於最多 $f$ 個節點為拜占庭節點，交集中必包含至少一個誠實節點。這確保了任何兩個 prepared 狀態的決策必然一致，因為它們共享至少一個誠實見證者。

活性（Liveness）保證客戶端請求最終會被執行，這依賴視圖更換（View Change）機制。當副本偵測到主節點故障（例如逾時未收到預準備訊息），將發起視圖更換，選舉新的主節點。新主節點 $p' = (v + 1) \mod n$ 需收集 $2f + 1$ 個視圖更換訊息，確認先前視圖中已達成的共識狀態，然後在新視圖中繼續處理請求。

視圖更換機制確保了即使主節點被攻陷或離線，系統仍能持續運作。由於拜占庭節點至多 $f$ 個，連續 $f$ 次視圖更換後必然會選出誠實的主節點，系統活性得以恢復。

### PBFT 的後續發展與本研究的選擇

PBFT 提出後，研究者針對其 $O(n^2)$ 通訊複雜度提出了多種改進方案。HotStuff [5] 透過流水線化的三階段協議與閾值簽章技術，將通訊複雜度降至 $O(n)$，已被 Meta 的 Diem 區塊鏈採用作為共識基礎。Tendermint [6] 將 PBFT 與權益證明機制結合，成為 Cosmos 生態系統的共識協議。Algorand [7] 則透過可驗證隨機函數（VRF）實現無需許可的委員會選舉，在公鏈環境下達成可擴展的拜占庭共識。

然而，這些改進主要針對共識協議本身的效率優化，而非應用層的安全機制設計。本研究的創新聚焦於「何時需要觸發共識」以及「如何設計挑戰機制」，而非「如何優化共識協議」。在本研究的目標場景中，驗證者數量通常在 10 至 20 個範圍內，PBFT 的通訊成本（每輪約數百則訊息）遠低於模型更新的傳輸成本（單個模型更新可達數 MB 至數百 MB），共識效率並非系統瓶頸。

本研究選擇 PBFT 作為挑戰機制的共識協議，基於三個考量：首先，PBFT 的安全性證明經過二十餘年的學術驗證，其理論基礎穩固，便於進行形式化的安全性分析。其次，本研究的框架設計採用模組化架構，挑戰機制與底層共識協議解耦，若未來部署於更大規模的網路，可將 PBFT 替換為 HotStuff 或其他改進協議，而無需修改上層機制。第三，PBFT 支援任意計算的驗證，不受零知識證明或詐欺證明所需的算術電路限制，這對於需要支援多種聚合演算法（如 Krum、FedProx、Median）的聯邦學習場景尤為重要。

## 2.3.3 委員會架構與區塊鏈聯邦學習

### 從全節點共識到委員會機制的演進

傳統 BFT 協議要求所有節點參與每一輪共識，導致通訊成本隨節點數平方增長。當區塊鏈系統需要支援數百甚至數千個節點時，此設計成為不可逾越的效能瓶頸。委員會架構（Committee-based Architecture）的核心理念是將共識責任委派給一個小型代表性子集，由委員會代替全網執行共識協議。

委員會架構的通訊成本可表示為：

$$\text{總通訊成本} = O(c^2) + O(n)$$

其中 $c$ 為委員會大小，$n$ 為全網節點數。當 $c \ll n$ 時，此成本遠低於全節點 PBFT 的 $O(n^2)$。委員會內部執行 BFT 共識的成本為 $O(c^2)$，委員會與全網的結果廣播成本為 $O(n)$。

### BCFL 中的委員會共識應用

委員會架構已被廣泛應用於區塊鏈聯邦學習系統。Li 等人提出的 BFLC 框架 [8] 是最早將委員會共識引入 BCFL 的研究之一。在 BFLC 中，系統從全體參與者中選出一個委員會，負責驗證客戶端提交的模型更新並執行聚合。委員會成員使用自身資料集對更新進行交叉驗證，計算品質分數後透過委員會共識決定是否接受。實驗結果顯示，當委員會大小為 5 時，相較於全節點 PBFT（$n = 20$），共識延遲從 120 毫秒降至 35 毫秒，通訊成本降低約 85%。

BlockDFL [9] 進一步將委員會機制與角色輪替結合。系統根據上一區塊的雜湊值，將參與者隨機分配為三種角色：更新提供者（Update Provider）負責本地訓練、聚合器（Aggregator）負責模型聚合、驗證者（Verifier）組成委員會執行共識。論文建議驗證者數量應「遠小於」總參與者數量以提升效率，實驗配置中使用 4 至 7 個驗證者處理 20 至 60 個參與者的系統。此設計使得 BlockDFL 在處理 166 萬參數的模型時，聚合與驗證時間低於 3 秒，相較於類似系統 Biscotti [10] 處理 7,850 參數需超過 30 秒，效能提升顯著。

FLCoin [11] 採用滑動視窗機制選舉委員會：節點透過提交有效的模型更新獲得「份額」，在固定大小的滑動視窗（通常設為 50 至 100）內持有份額的節點組成當輪委員會。此設計使得通訊複雜度維持在線性 $O(n)$，相較於傳統 PBFT 減少約 90% 的通訊開銷。論文實驗顯示，即使在 500 個節點的規模下，共識延遲仍低於 3 秒。

### 委員會架構的根本性安全隱患

儘管委員會架構顯著提升了 BCFL 系統的效率，其安全性卻建立在一個脆弱的假設之上：委員會成員的誠實多數。BlockDFL 明確指出，其共識機制「僅在超過三分之二的驗證者是誠實的情況下才能產生非空區塊」[9]。當委員會規模較小時，此假設尤其危險。

以 BlockDFL 的典型配置（7 個驗證者）為例，攻擊者若能控制 5 個驗證者，即可掌握超過三分之二的投票權，從而通過任意惡意的聚合結果。即使攻擊者在全網僅佔 30% 的節點，在隨機抽取 7 個驗證者的過程中，攻擊者佔據 5 席以上的機率雖低，但絕非為零。更重要的是，攻擊者可採用「等待策略」：平時潛伏並表現誠實以累積權益（Stake），僅在他們控制的節點「中獎」成為委員會多數時才發動攻擊。在這種情況下，由於共識僅在小型委員會內部達成，攻擊者可直接操控投票結果，繞過所有資料層防禦機制。

此問題的根源在於委員會架構將「效率」與「安全性」綁定在同一個元件上：委員會既負責提供系統活性（持續處理更新），也負責提供安全性保證（驗證更新正確性）。當委員會被攻陷時，兩者同時失效。

### 漸進式委員會佔領攻擊

現有委員會架構面臨的更深層威脅是漸進式佔領攻擊（Progressive Committee Capture Attack）。此攻擊利用權益累積機制的正回饋特性，透過兩階段策略逐步控制委員會：

**潛伏階段**：攻擊者控制的節點在初期表現完全誠實，正常參與訓練並提交高品質的模型更新。透過持續的誠實行為，攻擊節點累積權益與聲譽，提高被選入委員會的機率。

**佔領階段**：當攻擊節點首次在某一輪佔據委員會多數席位時，他們可以操控共識結果，將獎勵僅分配給自己控制的節點，同時拒絕誠實節點的更新。由於委員會選舉通常基於權益或聲譽，此操作使攻擊者的相對權益份額持續增加，進一步提高其在未來輪次佔據委員會多數的機率，形成自我強化的惡性循環。

此攻擊的危險性在於其隱蔽性：攻擊者無需在任何時刻控制全網多數節點，僅需耐心等待並利用概率波動。一旦成功佔領委員會，現有系統缺乏有效的偵測與清除機制。BlockDFL 指出惡意領導者「只能拒絕投票並廣播空區塊以延遲迭代」[9]，但未分析多個被攻陷驗證者協同作惡的場景。當被攻陷的委員會成為「合法」權威時，系統無法區分正當權威與被佔領的權威。

### 現有方法的侷限性總結

綜合以上分析，現有 BCFL 委員會架構存在三個根本性侷限：

第一，**誠實多數假設的脆弱性**。無論採用隨機抽樣、權益加權或聲譽評分，所有委員會選舉機制都假設某種形式的誠實多數——無論是機率意義上的（隨機選中的委員會大概率誠實）還是經濟意義上的（持有較多權益的節點傾向誠實）。然而，這些假設在面對策略性攻擊者時並不穩固。

第二，**效率與安全性的耦合設計**。現有架構將委員會同時用於提供活性與安全性，使得攻擊者一旦控制委員會即可同時破壞兩者。這種耦合設計源於傳統 BFT 共識的思維慣性，但在 BCFL 的應用場景中並非必要。

第三，**缺乏事後偵測與清除機制**。一旦惡意節點透過合法途徑（累積權益、建立聲譽）獲得委員會席位，現有系統無法事後偵測其惡意行為，也無法在發現惡意行為後將其清除。被攻陷的狀態成為新的「合法」狀態，系統缺乏自我修復能力。

本研究針對上述侷限，提出將安全性保證從委員會層級提升至全網層級的架構設計。透過將「活性」與「安全性」解耦——由小型委員會負責日常的樂觀執行以提供活性，由挑戰機制配合全網 PBFT 共識提供安全性保證——系統可在維持效率的同時抵禦委員會佔領攻擊。具體機制設計詳見第四章。

---

## 參考文獻

[1] L. Lamport, R. Shostak, and M. Pease, "The Byzantine generals problem," *ACM Trans. Program. Lang. Syst.*, vol. 4, no. 3, pp. 382–401, Jul. 1982.

[2] L. Lamport, "Paxos made simple," *ACM SIGACT News*, vol. 32, no. 4, pp. 51–58, Dec. 2001.

[3] D. Ongaro and J. Ousterhout, "In search of an understandable consensus algorithm," in *Proc. USENIX Annu. Tech. Conf.*, Philadelphia, PA, USA, Jun. 2014, pp. 305–319.

[4] M. Castro and B. Liskov, "Practical Byzantine fault tolerance," in *Proc. 3rd Symp. Operating Syst. Design Implement. (OSDI)*, New Orleans, LA, USA, Feb. 1999, pp. 173–186.

[5] M. Yin, D. Malkhi, M. K. Reiter, G. G. Gueta, and I. Abraham, "HotStuff: BFT consensus with linearity and responsiveness," in *Proc. ACM Symp. Principles Distrib. Comput. (PODC)*, Toronto, ON, Canada, Jul. 2019, pp. 347–356.

[6] E. Buchman, J. Kwon, and Z. Milosevic, "The latest gossip on BFT consensus," *arXiv preprint arXiv:1807.04938*, 2018.

[7] Y. Gilad, R. Hemo, S. Micali, G. Vlachos, and N. Zeldovich, "Algorand: Scaling Byzantine agreements for cryptocurrencies," in *Proc. 26th Symp. Operating Syst. Principles (SOSP)*, Shanghai, China, Oct. 2017, pp. 51–68.

[8] Y. Li, C. Chen, N. Liu, H. Huang, Z. Zheng, and Q. Yan, "A blockchain-based decentralized federated learning framework with committee consensus," *IEEE Netw.*, vol. 35, no. 1, pp. 234–241, Jan./Feb. 2021.

[9] Z. Qin, X. Yan, M. Zhou, and S. Deng, "BlockDFL: A blockchain-based fully decentralized peer-to-peer federated learning framework," in *Proc. ACM Web Conf. (WWW)*, Singapore, May 2024, pp. 2914–2925.

[10] N. Shayan, C. Fung, C. J. M. Yoon, and I. Beschastnikh, "Biscotti: A blockchain system for private and secure federated learning," *IEEE Trans. Parallel Distrib. Syst.*, vol. 32, no. 7, pp. 1513–1525, Jul. 2021.

[11] S. Ren, E. Kim, and C. Lee, "A scalable blockchain-enabled federated learning architecture for edge computing," *PLOS ONE*, vol. 19, no. 8, e0308991, Aug. 2024.